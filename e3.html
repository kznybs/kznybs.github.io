<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>PokerMaster Manager</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Teko:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-accent: #21262d;
            --border-color: #30363d;
            --text-light: #c9d1d9;
            --text-medium: #8b949e;
            --text-dark: #111827;
            --primary: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --yellow: #fbbf24;
            --bg-overlay: rgba(255, 255, 255, 0.15);
            
            /* Chip Colors */
            --chip-blue-bg: #1e88e5;
            --chip-blue-outline: rgba(255, 255, 255, 0.3);
            --chip-white-bg: #e0e0e0;
            --chip-white-outline: rgba(0, 0, 0, 0.2);
            --chip-black-bg: #212121;
            --chip-black-outline: rgba(255, 255, 255, 0.2);
            --chip-green-bg: #43a047;
            --chip-green-outline: rgba(255, 255, 255, 0.3);
            --chip-red-bg: #e53935;
            --chip-red-outline: rgba(255, 255, 255, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            height: 100%; 
        }
        
        body { background-color: var(--bg-dark); color: var(--text-light); font-family: 'Roboto Mono', monospace; }
        .hidden { display: none !important; }
        
        .screen { 
            height: 100vh; 
            padding: 1.5rem 1rem; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
            overflow-y: auto;
        }

        #home-screen { gap: 1rem; }
        
        .card { background-color: var(--bg-card); border-radius: 16px; padding: 1rem; border: 1px solid var(--border-color); }
        .btn { border: none; border-radius: 12px; padding: 0.75rem; font-weight: bold; cursor: pointer; transition: all 0.2s ease; font-family: 'Teko', sans-serif; font-size: 1.5rem; letter-spacing: 1px; }
        .btn:active { transform: scale(0.97); }

        #home-screen .header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem; flex-shrink: 0; }
        #home-screen .header-block { text-align: center; flex: 1; }
        #home-screen .header-block.timer { flex: 1.5; }
        #home-screen .header-label { font-family: 'Teko', sans-serif; font-size: 1rem; color: var(--text-medium); }
        #home-screen .header-value { font-family: 'Teko', sans-serif; font-size: 2.5rem; color: var(--text-light); line-height: 1; }
        #home-screen .header-value.blinds { color: var(--primary); }
        #home-screen .settings-btn { font-size: 1.5rem; color: var(--text-medium); cursor: pointer; position: absolute; top: 1.5rem; right: 1rem; }

        #home-screen .pot-card { text-align: center; border: 2px solid var(--primary); flex-shrink: 0; }
        #home-screen .pot-label { font-family: 'Teko', sans-serif; font-size: 1.5rem; color: var(--text-medium); }
        #home-screen .pot-value { font-family: 'Teko', sans-serif; font-size: 3.5rem; color: var(--text-light); line-height: 1; }

        #home-screen .ranking-card { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        #home-screen .ranking-card .card-title { font-family: 'Teko', sans-serif; font-size: 2rem; text-align: center; color: #FFF; margin-bottom: 1rem; flex-shrink: 0; }
        #home-screen .player-list { display: flex; flex-direction: column; gap: 0.75rem; overflow-y: auto; flex-grow: 1; }
        #home-screen .player-item { display: flex; align-items: center; gap: 0.75rem; }
        #home-screen .player-position { font-family: 'Teko', sans-serif; font-size: 1.5rem; color: var(--text-medium); width: 2rem; }
        #home-screen .player-stack { background-color: var(--primary); color: var(--text-dark); font-weight: bold; padding: 0.5rem; border-radius: 8px; flex-shrink: 0; cursor: pointer; }
        #home-screen .player-name { background-color: var(--bg-accent); color: var(--text-light); padding: 0.5rem; border-radius: 8px; flex-grow: 1; text-align: left; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #home-screen .player-current-bet { font-size: 0.7rem; color: var(--yellow); }
        #home-screen .select-winner-btn { background-color: var(--bg-accent); color: var(--green); font-size: 1.5rem; border-radius: 8px; width: 40px; height: 40px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        #home-screen .select-winner-btn.selected { background-color: var(--green); color: var(--text-dark); }
        
        #home-screen .actions { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; flex-shrink: 0; }
        #home-screen .actions .btn { flex: 1; }
        #home-screen .btn-distribute { background-color: var(--primary); color: var(--text-dark); }
        #home-screen .btn-reset-all { background-color: var(--red); color: white; }
        
        .credits-footer { text-align: center; margin-top: auto; padding-top: 1rem; color: var(--text-medium); font-size: 0.8rem; flex-shrink: 0; }

        .sub-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-dark); z-index: 100; display: flex; flex-direction: column; padding: 1.5rem 1rem; gap: 1rem; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .sub-screen.active { transform: translateX(0); }
        
        .sub-screen-main-content { flex-grow: 1; min-height: 0; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }

        .sub-screen-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-shrink: 0; }
        .sub-screen-header .nav-arrow { font-size: 2rem; color: var(--text-medium); padding: 0.5rem; cursor: pointer; }
        .sub-screen-header .player-name-display { font-family: 'Teko', sans-serif; font-size: 2.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .sub-screen-header .player-name-display .edit-icon { font-size: 1.5rem; vertical-align: middle; color: var(--text-medium); cursor: pointer; }

        .total-display-card { text-align: center; border: 2px solid var(--primary); padding: 1rem; flex-shrink: 0; }
        .total-display-card .total-label { font-family: 'Teko', sans-serif; font-size: 1.5rem; color: var(--text-medium); }
        .total-display-card .total-value { font-family: 'Teko', sans-serif; font-size: 4rem; color: var(--text-light); line-height: 1; }

        .chip-area { margin-top: 1rem; flex-shrink: 0; }
        .chip-area-title { color: var(--text-medium); margin-bottom: 0.5rem; text-align: center; }
        
        .chip-selector { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); 
            gap: 1rem; 
            margin-top: 1rem; 
        }
        
        .chip-btn {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: none;
            padding: 0;
            transition: transform 0.2s ease;
            outline-style: solid;
        }
        .chip-btn:active {
            transform: scale(0.95);
        }
        .chip-btn .value {
            font-family: 'Teko', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1;
        }
        .chip-btn .count {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            font-weight: 700;
            line-height: 1;
        }

        .chip-stack-visualizer {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            min-height: 100px;
            background-color: var(--bg-accent);
            border-radius: 12px;
        }
        .chip-stack-visualizer .chip-btn {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
        }
        .chip-stack-visualizer .chip-btn .value { font-size: 1.8rem; }
        .chip-stack-visualizer .chip-btn .count { font-size: 0.7rem; }

        .chip-blue { 
            background-color: var(--chip-blue-bg); 
            color: white;
            outline-color: var(--chip-blue-outline);
            outline-width: 8px;
            outline-offset: -8px;
        }
        .chip-white { 
            background-color: var(--chip-white-bg); 
            color: black;
            outline-color: var(--chip-white-outline);
            outline-width: 8px;
            outline-offset: -8px;
        }
        .chip-black { 
            background-color: var(--chip-black-bg); 
            color: white;
            outline-color: var(--chip-black-outline);
            outline-width: 8px;
            outline-offset: -8px;
        }
        .chip-green { 
            background-color: var(--chip-green-bg); 
            color: white;
            outline-color: var(--chip-green-outline);
            outline-width: 8px;
            outline-offset: -8px;
        }
        .chip-red { 
            background-color: var(--chip-red-bg); 
            color: white;
            outline-color: var(--chip-red-outline);
            outline-width: 8px;
            outline-offset: -8px;
        }

        .sub-screen-footer { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 1rem; padding-top: 1rem; flex-shrink: 0; }
        .sub-screen-footer .footer-top-row { display: flex; width: 100%; gap: 13.72px; align-items: center; }
        
        .sub-screen-footer .prev-btn,
        .sub-screen-footer .home-btn {
            width: 44.42px;
            height: 36.11px;
            padding: 2.84px;
            background: var(--bg-overlay);
            border-radius: 6.82px;
            color: white;
            font-size: 10.83px;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            line-height: 1.2;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .sub-screen-footer .home-btn svg {
            width: 22px;
            height: 22px;
            stroke-width: 2.5;
        }

        .sub-screen-footer .main-action-btn {
            flex: 1 1 0;
            height: 36.11px;
            padding: 2.84px;
            background: var(--primary);
            border-radius: 6.82px;
            color: var(--text-dark);
            font-size: 10.83px;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #end-betting-btn {
            width: 100%;
            height: 24.92px;
            padding: 3.36px;
            background: var(--bg-overlay);
            border-radius: 8.06px;
            border: 1.08px solid var(--primary);
            color: white;
            font-size: 10.83px;
            font-family: 'Roboto Mono', monospace;
            font-weight: 400;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #end-betting-btn:active {
            transform: scale(0.98);
        }

        #settings-screen .timer-config-card { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        #settings-screen .level-nav { display: flex; align-items: center; gap: 1rem; }
        #settings-screen .level-nav .btn { font-size: 2rem; padding: 0 1rem; }
        #settings-screen .level-display { font-size: 1.5rem; text-align: center; }
        #settings-screen .input-group { display: flex; align-items: center; gap: 0.5rem; background-color: var(--bg-accent); padding: 0.5rem 1rem; border-radius: 8px; }
        #settings-screen .input-group input { background: none; border: none; color: #FFF; font-size: 1rem; width: 50px; text-align: center; }
        #settings-screen .main-controls { display: flex; gap: 1rem; }
        #settings-screen .btn-start-pause { background-color: var(--green); color: var(--text-dark); }
        #settings-screen .btn-start-pause.paused { background-color: var(--primary); }
        #settings-screen .btn-reset-timer { background-color: var(--red); color: white; }

        /* --- AJUSTES PARA TELAS MENORES (MOBILE) --- */
        @media (max-width: 640px) {
            .screen { padding: 1rem 0.75rem; gap: 0.75rem; }
            .btn { font-size: 1.2rem; padding: 0.6rem; }
            #home-screen .header-value { font-size: 1.8rem; }
            #home-screen .header-label { font-size: 0.8rem; }
            #home-screen .pot-value { font-size: 2.8rem; }
            #home-screen .pot-label { font-size: 1.2rem; }
            #home-screen .ranking-card .card-title { font-size: 1.5rem; margin-bottom: 0.5rem;}
            #home-screen .player-list { gap: 0.5rem; }
            #home-screen .player-stack { padding: 0.4rem; font-size: 1rem; }
            #home-screen .player-name { padding: 0.4rem; font-size: 1rem; }
            #home-screen .player-position { font-size: 1.2rem; }
            .sub-screen-header .player-name-display { font-size: 1.8rem; }
            .sub-screen-header .player-name-display .edit-icon { font-size: 1.2rem; }
            .sub-screen-header .nav-arrow { font-size: 1.8rem; }
            .total-display-card .total-value { font-size: 3rem; }
            .total-display-card .total-label { font-size: 1.2rem; }
            .chip-selector { 
                grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
                gap: 0.75rem;
            }
            .chip-btn .value { font-size: 1.8rem; }
            .chip-btn .count { font-size: 0.7rem; }
            .chip-stack-visualizer { min-height: 80px; }
            .chip-stack-visualizer .chip-btn { width: 60px; height: 60px; }
            .chip-stack-visualizer .chip-btn .value { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- Tela Home -->
    <div id="home-screen" class="screen">
        <header class="header">
            <div class="header-block">
                <div class="header-label">RODADA</div>
                <div id="home-round-num" class="header-value">1</div>
            </div>
            <div class="header-block timer">
                <div class="header-label">TIMER</div>
                <div id="home-timer-display" class="header-value">15:00</div>
            </div>
            <div class="header-block">
                <div class="header-label">BLINDS</div>
                <div id="home-blinds-display" class="header-value blinds">25/50</div>
            </div>
        </header>
        <div id="settings-btn" class="settings-btn">⚙️</div>

        <div class="card pot-card">
            <div class="pot-label">Total no Pote</div>
            <div id="home-pot-value" class="pot-value">0</div>
        </div>
        <div class="card ranking-card">
            <h2 class="card-title">RANKING</h2>
            <div id="player-list" class="player-list"></div>
        </div>
        <div class="actions">
            <button id="distribute-btn" class="btn btn-distribute">Distribuir</button>
            <button id="reset-btn" class="btn btn-reset-all">Resetar Fichas de Todos</button>
        </div>
    </div>

    <!-- Tela de Aposta -->
    <div id="bet-screen" class="sub-screen">
        <header class="sub-screen-header">
            <div id="bet-prev-player" class="nav-arrow">&lt;</div>
            <div id="bet-player-name" class="player-name-display">JOGADOR 1</div>
            <div id="bet-next-player" class="nav-arrow">&gt;</div>
        </header>
        <div class="sub-screen-main-content">
            <div class="card total-display-card">
                <div class="total-label">Apostado</div>
                <div id="bet-total-value" class="total-value">0</div>
            </div>
            <div class="chip-area">
                <div class="chip-area-title">Remover</div>
                <div id="bet-stack-visualizer" class="chip-stack-visualizer"></div>
            </div>
            <div class="chip-area">
                <div class="chip-area-title">Apostar</div>
                <div id="bet-chip-selector" class="chip-selector"></div>
            </div>
        </div>
        <footer class="sub-screen-footer">
            <div class="footer-top-row">
                <button class="btn prev-btn" data-target="bet">&lt;<br>Ant.</button>
                <button class="btn home-btn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9.5L12 4L21 9.5V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 22V12H15V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="bet-confirm-btn" class="btn main-action-btn">Apostar</button>
            </div>
            <button id="end-betting-btn">Finalizar Apostas</button>
        </footer>
    </div>

    <!-- Tela de Gerenciamento -->
    <div id="manage-screen" class="sub-screen">
        <header class="sub-screen-header">
            <div id="manage-prev-player" class="nav-arrow">&lt;</div>
            <div id="manage-player-name" class="player-name-display">JOGADOR 1 <span class="edit-icon">✎</span></div>
            <div id="manage-next-player" class="nav-arrow">&gt;</div>
        </header>
        <div class="sub-screen-main-content">
            <div class="card total-display-card">
                <div class="total-label">Stack Total</div>
                <div id="manage-total-value" class="total-value">2400</div>
            </div>
            <div class="chip-area">
                <div class="chip-area-title">Remover do Stack</div>
                <div id="manage-stack-visualizer" class="chip-stack-visualizer"></div>
            </div>
            <div class="chip-area">
                <div class="chip-area-title">Adicionar ao Stack</div>
                <div id="manage-chip-selector" class="chip-selector"></div>
            </div>
        </div>
        <footer class="sub-screen-footer">
             <div class="footer-top-row">
                <button class="btn prev-btn" data-target="manage">&lt;<br>Ant.</button>
                <button class="btn home-btn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9.5L12 4L21 9.5V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 22V12H15V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="manage-save-btn" class="btn main-action-btn">Salvar</button>
             </div>
        </footer>
    </div>
    
    <!-- Tela de Configurações do Timer -->
    <div id="settings-screen" class="sub-screen">
        <header class="sub-screen-header">
            <div class="nav-arrow" style="visibility: hidden;">&lt;</div>
            <div class="player-name-display">TIMER</div>
            <div class="nav-arrow home-btn" style="font-size: 1.5rem;">✖</div>
        </header>
        <div class="card timer-config-card">
            <div class="level-nav">
                <button id="timer-prev-level-btn" class="btn">&lt;</button>
                <div class="level-display">
                    <div class="header-label">RODADA <span id="settings-round-num">1</span></div>
                    <div id="settings-blinds-display" class="header-value blinds">25/50</div>
                </div>
                <button id="timer-next-level-btn" class="btn">&gt;</button>
            </div>
            <div class="input-group">
                <label for="timer-input">Duração (min):</label>
                <input type="number" id="timer-input" value="15">
            </div>
            <div class="main-controls">
                <button id="timer-start-pause-btn" class="btn btn-start-pause paused">INICIAR</button>
                <button id="timer-reset-btn" class="btn btn-reset-timer">RESETAR</button>
            </div>
        </div>
        <footer class="credits-footer">
            <p>Desenvolvido por Gabriel, Vinicius e Adilson @ 2025</p>
        </footer>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURAÇÃO ---
        const CHIP_TYPES = {
            blue: { value: 400, class: 'chip-blue' },
            white: { value: 200, class: 'chip-white' },
            black: { value: 50, class: 'chip-black' },
            green: { value: 25, class: 'chip-green' },
            red: { value: 25, class: 'chip-red' },
        };
        const INITIAL_CHIPS = { white: 8, red: 8, green: 8, black: 8, blue: 0 };
        const NUM_PLAYERS = 6;
        const BLIND_LEVELS = [
            { small: 25, big: 50 }, { small: 50, big: 100 }, { small: 75, big: 150 },
            { small: 100, big: 200 }, { small: 150, big: 300 }, { small: 200, big: 400 },
            { small: 250, big: 500 }, { small: 300, big: 600 }, { small: 400, big: 800 },
            { small: 500, big: 1000 }, { small: 600, big: 1200 }, { small: 800, big: 1600 },
            { small: 1000, big: 2000 }
        ];

        // --- ESTADO DO JOGO ---
        let state = {};
        let timerInterval = null;

        // --- ELEMENTOS DO DOM ---
        const screens = {
            home: document.getElementById('home-screen'),
            bet: document.getElementById('bet-screen'),
            manage: document.getElementById('manage-screen'),
            settings: document.getElementById('settings-screen'),
        };
        
        // --- Lógica Principal ---
        function saveState() {
            localStorage.setItem('pokerMasterStateV12', JSON.stringify(state));
        }

        function calculateStack(player) {
            if (!player || !player.chips) return 0;
            return Object.entries(player.chips).reduce((sum, [type, count]) => sum + (CHIP_TYPES[type].value * count), 0);
        }
        
        function calculateRoundBetValue(player) {
            if (!player || !player.roundBet) return 0;
            return Object.entries(player.roundBet).reduce((sum, [type, count]) => sum + (CHIP_TYPES[type].value * count), 0);
        }

        function calculatePotValue() {
            if (!state.pot) return 0;
            return Object.entries(state.pot).reduce((sum, [type, count]) => sum + (CHIP_TYPES[type].value * count), 0);
        }

        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }
        }
        
        // --- RENDERIZAÇÃO ---
        function renderAll() {
            renderHomeScreen();
            renderTimer();
            saveState();
        }

        function renderHomeScreen() {
            state.players.sort((a, b) => calculateStack(b) - calculateStack(a));
            
            const playerListEl = document.getElementById('player-list');
            playerListEl.innerHTML = '';
            state.players.forEach((player, index) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'player-item';
                const roundBetValue = calculateRoundBetValue(player);
                const betDisplay = roundBetValue > 0 ? `<div class="player-current-bet">Aposta: ${roundBetValue}</div>` : '';

                playerEl.innerHTML = `
                    <div class="player-position">${index + 1}º</div>
                    <div style="text-align: center;">
                        <button class="player-stack" data-player-id="${player.id}">${calculateStack(player).toLocaleString('pt-BR')}</button>
                        ${betDisplay}
                    </div>
                    <button class="player-name" data-player-id="${player.id}">${player.name}</button>
                    <button class="select-winner-btn ${player.selectedForPot ? 'selected' : ''}" data-player-id="${player.id}">+</button>
                `;
                playerListEl.appendChild(playerEl);
            });
            document.getElementById('home-pot-value').textContent = calculatePotValue().toLocaleString('pt-BR');
        }

        function renderBetScreen(playerId) {
            state.activePlayerId = playerId;
            state.currentBet = {};

            const player = state.players.find(p => p.id === playerId);
            if (!player) return;

            document.getElementById('bet-player-name').textContent = player.name;
            
            renderBetVisuals(playerId);
            switchScreen('bet');
        }

        function renderBetVisuals(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;

            const roundBetValue = calculateRoundBetValue(player);
            const currentBetChangeValue = Object.entries(state.currentBet).reduce((sum, [type, count]) => sum + (CHIP_TYPES[type].value * count), 0);
            document.getElementById('bet-total-value').textContent = (roundBetValue + currentBetChangeValue).toLocaleString('pt-BR');

            const visualizerEl = document.getElementById('bet-stack-visualizer');
            visualizerEl.innerHTML = '';
            
            const chipsToVisualize = {...player.roundBet};
            Object.entries(state.currentBet).forEach(([type, count]) => {
                chipsToVisualize[type] = (chipsToVisualize[type] || 0) + count;
            });

            Object.entries(chipsToVisualize).forEach(([type, count]) => {
                if (count > 0) {
                    const config = CHIP_TYPES[type];
                    const chipBtn = document.createElement('button');
                    chipBtn.className = `btn chip-btn ${config.class}`;
                    chipBtn.dataset.chipType = type;
                    chipBtn.innerHTML = `<div class="value">${config.value}</div><div class="count">${count}</div>`;
                    visualizerEl.appendChild(chipBtn);
                }
            });

            const selectorEl = document.getElementById('bet-chip-selector');
            selectorEl.innerHTML = '';
            Object.entries(CHIP_TYPES).forEach(([type, config]) => {
                const chipsTakenFromHand = Math.max(0, state.currentBet[type] || 0);
                const remainingInHand = player.chips[type] - chipsTakenFromHand;
                
                if (remainingInHand > 0) {
                     const chipBtn = document.createElement('button');
                     chipBtn.className = `btn chip-btn ${config.class}`;
                     chipBtn.dataset.chipType = type;
                     chipBtn.innerHTML = `<div class="value">${config.value}</div><div class="count">${remainingInHand}</div>`;
                     selectorEl.appendChild(chipBtn);
                }
            });
        }
        
        function renderManageScreen(playerId) {
            state.activePlayerId = playerId;
            state.manageChips = {};

            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            
            document.getElementById('manage-player-name').innerHTML = `${player.name} <span class="edit-icon">✎</span>`;
            
            const selectorEl = document.getElementById('manage-chip-selector');
            selectorEl.innerHTML = '';
            Object.entries(CHIP_TYPES).forEach(([type, config]) => {
                 const chipBtn = document.createElement('button');
                 chipBtn.className = `btn chip-btn ${config.class}`;
                 chipBtn.dataset.chipType = type;
                 chipBtn.innerHTML = `<div class="value">${config.value}</div><div class="count">∞</div>`;
                 selectorEl.appendChild(chipBtn);
            });
            renderManageVisuals(playerId);
            switchScreen('manage');
        }

        function renderManageVisuals(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            let currentStack = calculateStack(player);
            let changeValue = 0;
            
            const visualizerEl = document.getElementById('manage-stack-visualizer');
            visualizerEl.innerHTML = '';

            const tempChips = { ...player.chips };
            Object.entries(state.manageChips).forEach(([type, count]) => {
                tempChips[type] = (tempChips[type] || 0) + count;
                changeValue += CHIP_TYPES[type].value * count;
            });

            Object.entries(tempChips).forEach(([type, count]) => {
                if(count > 0) {
                    const config = CHIP_TYPES[type];
                    const chipBtn = document.createElement('button');
                    chipBtn.className = `btn chip-btn ${config.class}`;
                    chipBtn.dataset.chipType = type;
                    chipBtn.innerHTML = `<div class="value">${config.value}</div><div class="count">${count}</div>`;
                    visualizerEl.appendChild(chipBtn);
                }
            });
            
            document.getElementById('manage-total-value').textContent = (currentStack + changeValue).toLocaleString('pt-BR');
        }

        function getNextPlayerId(currentId) {
            const numericallySortedPlayers = [...state.players].sort((a, b) => a.id - b.id);
            const currentIndex = numericallySortedPlayers.findIndex(p => p.id === currentId);
            const nextIndex = (currentIndex + 1) % numericallySortedPlayers.length;
            return numericallySortedPlayers[nextIndex].id;
        }

        function getPrevPlayerId(currentId) {
            const numericallySortedPlayers = [...state.players].sort((a, b) => a.id - b.id);
            const currentIndex = numericallySortedPlayers.findIndex(p => p.id === currentId);
            const prevIndex = (currentIndex - 1 + numericallySortedPlayers.length) % numericallySortedPlayers.length;
            return numericallySortedPlayers[prevIndex].id;
        }

        // --- Lógica do Timer ---
        function formatTime(s) { return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }

        function renderTimer() {
            const timer = state.timer;
            const level = BLIND_LEVELS[timer.round];
            const blindsText = level ? `${level.small}/${level.big}` : 'FIM';

            document.getElementById('home-timer-display').textContent = formatTime(timer.time);
            document.getElementById('home-round-num').textContent = timer.round + 1;
            document.getElementById('home-blinds-display').textContent = blindsText;
            
            document.getElementById('settings-round-num').textContent = timer.round + 1;
            document.getElementById('settings-blinds-display').textContent = blindsText;
            
            const startPauseBtn = document.getElementById('timer-start-pause-btn');
            startPauseBtn.textContent = timer.isRunning ? 'PAUSAR' : 'INICIAR';
            startPauseBtn.classList.toggle('paused', !timer.isRunning);
            
            document.getElementById('timer-input').value = timer.duration;
            document.getElementById('timer-input').disabled = timer.isRunning;
            document.getElementById('timer-prev-level-btn').disabled = timer.isRunning;
            document.getElementById('timer-next-level-btn').disabled = timer.isRunning;
        }

        function handleStartPause() {
            state.timer.isRunning = !state.timer.isRunning;
            if (state.timer.isRunning) {
                state.timer.endTime = Date.now() + state.timer.time * 1000;
                timerInterval = setInterval(tick, 1000);
            } else {
                clearInterval(timerInterval);
                timerInterval = null;
                state.timer.endTime = null;
            }
            renderTimer();
            saveState();
        }

        function tick() {
            if (!state.timer.isRunning || !state.timer.endTime) return;
            
            let newTime = Math.round((state.timer.endTime - Date.now()) / 1000);
            if (newTime < 0) newTime = 0;

            if (newTime === 0 && state.timer.time > 0) { // Time just ran out
                levelUp();
            }
            state.timer.time = newTime;
            renderTimer();
            saveState();
        }

        function levelUp() {
            if (state.timer.round < BLIND_LEVELS.length - 1) {
                state.timer.round++;
                state.timer.time = state.timer.duration * 60;
                if(state.timer.isRunning) {
                    state.timer.endTime = Date.now() + state.timer.time * 1000;
                }
                try { if (navigator.vibrate) navigator.vibrate(200); } catch(e){}
            } else {
                state.timer.isRunning = false;
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function levelDown() {
            if (state.timer.round > 0) {
                state.timer.round--;
                state.timer.time = state.timer.duration * 60;
            }
        }
        
        function resetTimer() {
             state.timer.round = 0;
             state.timer.time = state.timer.duration * 60;
             if (state.timer.isRunning) {
                 handleStartPause(); // Pausa o timer
             }
             renderTimer();
             saveState();
        }


        // --- MANIPULADORES DE EVENTOS ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            
            // Navegação Home
            if (target.closest('.player-stack')) { renderBetScreen(parseInt(target.closest('.player-stack').dataset.playerId)); return; }
            if (target.closest('.player-name')) { renderManageScreen(parseInt(target.closest('.player-name').dataset.playerId)); return; }
            if (target.closest('.select-winner-btn')) {
                const player = state.players.find(p => p.id === parseInt(target.closest('.select-winner-btn').dataset.playerId));
                player.selectedForPot = !player.selectedForPot;
                renderHomeScreen();
                saveState();
                return;
            }
            if (target.closest('#distribute-btn')) {
                const winners = state.players.filter(p => p.selectedForPot);
                if (winners.length > 0 && calculatePotValue() > 0) {
                    if (winners.length === 1) {
                        const winner = winners[0];
                        Object.keys(state.pot).forEach(chipType => {
                            winner.chips[chipType] = (winner.chips[chipType] || 0) + state.pot[chipType];
                        });
                    } else {
                        const totalPotValue = calculatePotValue();
                        const valuePerWinner = Math.floor(totalPotValue / winners.length);
                        winners.forEach(winner => {
                            let valueToDistribute = valuePerWinner;
                            const sortedChipTypes = Object.keys(CHIP_TYPES).sort((a, b) => CHIP_TYPES[b].value - CHIP_TYPES[a].value);
                            sortedChipTypes.forEach(type => {
                                const chipValue = CHIP_TYPES[type].value;
                                if (valueToDistribute >= chipValue) {
                                    const numChips = Math.floor(valueToDistribute / chipValue);
                                    winner.chips[type] = (winner.chips[type] || 0) + numChips;
                                    valueToDistribute -= numChips * chipValue;
                                }
                            });
                        });
                    }
                    state.pot = { white: 0, red: 0, green: 0, black: 0, blue: 0 };
                    state.players.forEach(p => p.selectedForPot = false);
                    renderAll();
                }
                return;
            }
            if (target.closest('#reset-btn')) {
                if (confirm('Tem certeza que deseja resetar todas as fichas?')) {
                    localStorage.removeItem('pokerMasterStateV12');
                    init();
                }
                return;
            }
            if (target.closest('#settings-btn')) { switchScreen('settings'); return; }

            // Tela de Aposta
            if (target.closest('#bet-chip-selector .chip-btn')) {
                const type = target.closest('.chip-btn').dataset.chipType;
                const player = state.players.find(p => p.id === state.activePlayerId);
                const betCount = state.currentBet[type] || 0;
                if (player.chips[type] > betCount) { 
                    state.currentBet[type] = (state.currentBet[type] || 0) + 1;
                    renderBetVisuals(state.activePlayerId); 
                }
                return;
            }
            if (target.closest('#bet-stack-visualizer .chip-btn')) {
                const type = target.closest('.chip-btn').dataset.chipType;
                const player = state.players.find(p => p.id === state.activePlayerId);
                const totalBetChips = (player.roundBet[type] || 0) + (state.currentBet[type] || 0);
                if (totalBetChips > 0) {
                    state.currentBet[type] = (state.currentBet[type] || 0) - 1;
                    renderBetVisuals(state.activePlayerId); 
                }
                return;
            }
            if (target.closest('#bet-confirm-btn')) {
                const currentPlayerId = state.activePlayerId;
                const player = state.players.find(p => p.id === currentPlayerId);
                
                Object.entries(state.currentBet).forEach(([type, count]) => {
                    player.chips[type] -= count;
                    player.roundBet[type] += count;
                });
                
                renderAll(); 

                const nextPlayerId = getNextPlayerId(currentPlayerId);
                renderBetScreen(nextPlayerId);
                return;
            }
            if (target.closest('#end-betting-btn')) {
                state.players.forEach(player => {
                    Object.entries(player.roundBet).forEach(([type, count]) => {
                        state.pot[type] = (state.pot[type] || 0) + count;
                    });
                    player.roundBet = { white: 0, red: 0, green: 0, black: 0, blue: 0 };
                });
                renderAll();
                switchScreen('home');
                return;
            }
            if (target.closest('#bet-next-player')) { renderBetScreen(getNextPlayerId(state.activePlayerId)); return; }
            
            // Botão "Anterior"
            if (target.closest('.prev-btn')) {
                const button = target.closest('.prev-btn');
                const targetScreen = button.dataset.target;
                if (targetScreen === 'bet') {
                    renderBetScreen(getPrevPlayerId(state.activePlayerId));
                } else if (targetScreen === 'manage') {
                    renderManageScreen(getPrevPlayerId(state.activePlayerId));
                }
                return;
            }

            // Tela de Gerenciamento
            if (target.closest('#manage-player-name .edit-icon')) {
                const player = state.players.find(p => p.id === state.activePlayerId);
                const newName = prompt('Digite o novo nome:', player.name);
                if (newName && newName.trim()) {
                    player.name = newName.trim();
                    renderManageScreen(player.id);
                    renderHomeScreen();
                    saveState();
                }
                return;
            }
            if (target.closest('#manage-chip-selector .chip-btn')) {
                const type = target.closest('.chip-btn').dataset.chipType;
                state.manageChips[type] = (state.manageChips[type] || 0) + 1;
                renderManageVisuals(state.activePlayerId);
                return;
            }
            if (target.closest('#manage-stack-visualizer .chip-btn')) {
                const type = target.closest('.chip-btn').dataset.chipType;
                const player = state.players.find(p => p.id === state.activePlayerId);
                if(player.chips[type] + (state.manageChips[type] || 0) > 0) {
                    state.manageChips[type] = (state.manageChips[type] || 0) - 1;
                    renderManageVisuals(state.activePlayerId);
                }
                return;
            }
            if (target.closest('#manage-save-btn')) {
                const player = state.players.find(p => p.id === state.activePlayerId);
                Object.entries(state.manageChips).forEach(([type, count]) => { player.chips[type] += count; });
                renderAll();
                switchScreen('home');
                return;
            }
            if (target.closest('#manage-next-player')) { renderManageScreen(getNextPlayerId(state.activePlayerId)); return; }
            
            // Tela de Configurações do Timer
            if (target.closest('#timer-start-pause-btn')) { handleStartPause(); return; }
            if (target.closest('#timer-reset-btn')) { resetTimer(); return; }
            if (target.closest('#timer-next-level-btn')) { levelUp(); renderTimer(); saveState(); return; }
            if (target.closest('#timer-prev-level-btn')) { levelDown(); renderTimer(); saveState(); return; }

            // Ações genéricas de cancelar/voltar
            if(target.closest('.home-btn')) { 
                switchScreen('home'); 
                return; 
            }
        });

        document.getElementById('timer-input').addEventListener('change', (e) => {
            if (!state.timer.isRunning) {
                state.timer.duration = parseInt(e.target.value);
                state.timer.time = state.timer.duration * 60;
                renderTimer();
                saveState();
            }
        });

        // --- INICIALIZAÇÃO ---
        function init() {
            const savedState = localStorage.getItem('pokerMasterStateV12');
            if (savedState) {
                state = JSON.parse(savedState);
                state.players.forEach(p => {
                    p.chips = p.chips || {};
                    p.roundBet = p.roundBet || { white: 0, red: 0, green: 0, black: 0, blue: 0 };
                });
                state.pot = state.pot || { white: 0, red: 0, green: 0, black: 0, blue: 0 };

                if (state.timer.isRunning && state.timer.endTime) {
                    const now = Date.now();
                    const newTime = Math.round((state.timer.endTime - now) / 1000);
                    
                    if (newTime <= 0) {
                        let timePassed = (now - state.timer.endTime) / 1000;
                        while(timePassed > 0 && state.timer.round < BLIND_LEVELS.length - 1) {
                            levelUp();
                            timePassed -= state.timer.duration * 60;
                        }
                        state.timer.time = Math.max(0, state.timer.time + timePassed);
                    } else {
                        state.timer.time = newTime;
                    }
                }
            } else {
                state = {
                    players: [],
                    pot: { white: 0, red: 0, green: 0, black: 0, blue: 0 },
                    activePlayerId: null,
                    currentBet: {},
                    manageChips: {},
                    timer: { round: 0, time: 15 * 60, isRunning: false, duration: 15, endTime: null }
                };
                for (let i = 1; i <= 6; i++) {
                    state.players.push({ 
                        id: i, 
                        name: `Jogador ${i}`, 
                        chips: { ...INITIAL_CHIPS }, 
                        roundBet: { white: 0, red: 0, green: 0, black: 0, blue: 0 },
                        selectedForPot: false 
                    });
                }
            }
            renderAll();
            if (state.timer.isRunning) {
                timerInterval = setInterval(tick, 1000);
            }
        }

        init();
    });
    </script>
</body>
</html>
